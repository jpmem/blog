---
title: パッケージ展開機能による Configuration Manager クライアント エージェントのバージョンアップ方法
date: 2022-06-10
tags:
  - MECM
---

みなさま、こんにちは。Configuration Manager サポート チームです。  

Configuration Manager では、Configuration Manager クライアント エージェントのバージョン アップ方法が複数ございます。  
自動クライアント アップグレードという機能が用意されておりますが、事前にテスト可能なコレクションは 1 つしか指定することはできず、その後にサイト全体へアップグレードを行うため、もう少し小刻みにバージョン アップをしたいというニーズがあることを、サポート インシデントを通してご要望頂くことがございます。  
そこで今回は、パッケージ展開機能を利用する方法についてご紹介いたします。  

## 目次

**A. パッケージとプログラムの作成**  
**B. パッケージの展開**  
**C. 展開結果の確認**  

## A. パッケージとプログラムの作成

1. プライマリ サイト サーバー上で、事前に共有フォルダーを作成します。共有ファルダ―は新規で作成し、このパッケージ専用として扱います。
例：**"\\\PriSite\CMClient\"**  

2. プライマリ サイト サーバーの以下のフォルダーにアクセスします。
パス：**"<サイトサーバーのインストール ドライブ>:\Program Files\Microsoft Configuration Manager\Client"**

3. ccmsetup.exe ファイルのみを、共有フォルダーにコピーします。(手順 5. で使います)
4. Configuration Manager コンソールを起動し、[ソフトウェア ライブラリ] > [アプリケーション管理] > [パッケージ] を右クリックし、[パッケージの作成] をクリックします。
5. [パッケージとプログラムの作成ウィザード] の [パッケージ] より、任意の名前を入力し、[このパッケージにソース ファイルを含める] にチェックを入れ、[参照] をクリックします。
6. [ソース フォルダー] の設定より、さらに [参照] をクリックし、共有フォルダーのパスを入力し、[OK] をクリックします。
7. [パッケージ] より、共有フォルダーのパスが登録されていることを確認し、[次へ] をクリックします。
8. [プログラムの種類] より、[標準プログラム] が選択されている状態のまま、[次へ] をクリックします。
9. [標準プログラム] より、以下の項目を設定し、[参照] をクリックします。

    - 名前：任意の名前   
    - コマンド ライン：  

    ```command
    ccmsetup.exe /noservice /mp:<管理ポイントの FQDN> SMSMP=<管理ポイントの FQDN> SMSSITECODE=<サイト コード>
    例)：ccmsetup.exe /noservice /mp:PriSite.contoso.com SMSMP=PriSite.contoso.com SMSSITECODE=PS1
    ```

    - プログラムの実行条件：ユーザーのログオン状態に関係なし  
    - 実行モード：管理者権限で実行する（自動で選択されます）  

10. [要件] より、必要に応じて設定を行い、[次へ] をクリックします。
11. [概要] より、設定内容に誤りがないことを確認し、[次へ] をクリックします。
12. [完了] より、正常に完了したことを確認し、[閉じる] をクリックします。
13. [パッケージ] の [ナビゲーション ペイン] より、作成したパッケージが登録されていることを確認します。

## B. パッケージの展開

1. Configuration Manager コンソールより、[ソフトウェア ライブラリ] > [アプリケーション管理] > [パッケージ] を開きます。
2. 先ほど作成したパッケージを右クリックし、[展開] をクリックし、[ソフトウェアの展開ウィザード] を開きます。
3. [全般] にて [コレクション] - [参照] をクリックし、展開先コレクションを指定し [OK] をクリックし、[次へ] をクリックします。
4. [コンテンツ] にて、[追加] をクリックし、配布ポイントを指定し、[次へ] をクリックします。
5. [展開設定] にて "目的" を [利用可能] とし、[次へ] をクリックします。
([必須] 場合にはサイレント実行されるため、テストする際には、[利用可能] とし、テストが成功することをご確認頂くことをお勧めいたします。)

6. [スケジュール] にて必要に応じたスケジュールを指定し、[次へ] をクリックします。
7. [ユーザー側の表示と操作] にて既定のまま [次へ] をクリックします。
8. [配布ポイント] にて、配布ポイントを指定して、[次へ] をクリックします。
9. [概要] にて [次へ] をクリックします。
10. ウィザードが完了したことを確認し、[閉じる] をクリックします。
11. 展開後、[パッケージ] の [ナビゲーション ペイン] より、展開したパッケージのコンテンツ ステータスが緑色の円グラフになることを確認します。
※画面をリフレッシュして、円グラフの更新状況を確認ください。  

## C. 展開結果の確認

パッケージ展開機能により ccmsetup.exe の配布を行うと、Configuration Manager エージェントのサービスが再起動されるため、パッケージの展開ステータスで、「プログラムで問題が発生しました (予期しなかった再起動)」 と記録されることがございます。  
これはステータスを送付するタイミングに依存して記録されるものであり、想定動作となりますのでご留意ください。  

そのため、バージョンアップが正しく行われたかどうかは、以下の確認方法を用います。  
基本的には、Configuration Manager サーバー側でバージョンアップされていることが確認できましたら、クライアントから管理ポイントへバージョン情報が正しく渡っているため、これにより正しくクライアントが動作していることを判断します。  

### レポートによる確認

1. Configuration Manager コンソールにて、[監視] > [レポート] > [レポート] > [サイト - クライアント情報] を選択します。
2. [Configuration Manager クライアント バージョン別の数] を右クリックし、[実行] をクリックします。
3. レポートの結果が表示されますので、各バージョンをクリックすると、バージョン別のクライアント一覧がご確認頂けます。

### デバイスの列名による確認

1. Configuration Manager コンソールにて、[資産とコンプライアンス] > [デバイス] を選択します。
2. 以下の列を追加し、各状態をチェックします。
・[アイコン]
・[名前]
・[クライアント]
・[クライアント アクティビティ]
・[クライアント バージョン]

3. 目安としては、以下の点をチェックします。
・アイコン：**緑色でチェックが付いているか**
・クライアント アクティビティ：**アクティブになっているか**
・クライアント バージョン：**想定バージョンになっているか**

    ![image.png](./20220610_01/20220609-01_01.png)  

4. そのほか、実際にバージョンアップ後のクライアントに対して、
パッケージ展開や、ソフトウェア更新プログラムの展開を行い、目的の配信が正常に進みますか確認を行います。
