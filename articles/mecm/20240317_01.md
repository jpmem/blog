---
title: オフライン環境の Configuration Manager 環境のアップデート手順
date: 2024-03-17
tags:
  - MECM  
---

# オフライン環境の Configuration Manager 環境のアップデート手順

みなさま、こんにちは。Configuration Manager サポート チームです。本日は、良くお問い合わせ頂く、インターネット環境に直接接続出来ない、オフライン環境の Configuration Manager (ConfigMgr) 環境のアップデート手順について、「サービス接続ツール」 を利用した手順をご案内致します。

サービス接続ツールそのものは以下公式ドキュメントでもご案内しております。

https://learn.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/use-the-service-connection-tool

本記事では、ConfigMgr CB 2211 から 2309 へのアップデートを例にご案内いたします。

# 作業の流れ

大凡の作業の流れは以下の通りです。

1. サービス接続ツールを使って、階層最上位サイトサーバー (中央管理サイトサーバー もしくは プライマリサイトサーバー) にて使用状況データを生成します。
2. サービス接続ツールと、使用状況データを、インターネット接続可能な別環境に複製します。
3. インターネット接続可能な別環境にて、サービス接続ツールを用いて使用状況データを弊社クラウドサービスにアップロードし、お使いの ConfigMgr 環境のアップデートに必要なパッケージをダウンロードします。
4. ダウンロードしたパッケージを、インターネット接続可能な別環境から、階層最上位サイトサーバー (中央管理サイトサーバー もしくは プライマリサイトサーバー)に複製します。
5. 階層最上位サイトサーバーにて、サービス接続ツールを用いて、ダウンロードしたパッケージを、インポートします。
6. アップデート前準備を行います。(サイトバックアップ、前提条件のクリア、アップデート中のサービス停止など)
7. アップデートを行います。
8. アップデート後作業を行います。

# 事前確認事項

## チェックリストの確認

通常のオンライン環境でも同様ですが、ターゲットバージョンの ConfigMgr 環境の事前チェックリストを確認しておきます。

更新プログラム 2309 for Configuration Managerをインストールするためのチェックリスト
https://learn.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/checklist-for-installing-update-2309

## インターネット接続条件の確認

更新プログラムパッケージをダウンロードするインターネット接続可能な別環境は、以下でご案内しております、短縮 URL 及び、「更新とサービス」節でご案内の URL 群にアクセス出来る必要がございます。直接の接続が難しく、プロキシサーバー を介す必要がある場合は、プロキシサーバー が以下でご案内の URL 群にアクセスできることをご確認ください。

https://learn.microsoft.com/ja-jp/mem/configmgr/core/plan-design/network/internet-endpoints

2024/3/17 現在ご案内している URL 群は以下の通りでございます。

- https://aka.ms
- https://go.microsoft.com
- *.akamaiedge.net
- *.akamaitechnologies.com
- *.manage.microsoft.com
- download.microsoft.com
- download.windowsupdate.com
- download.visualstudio.microsoft.com
- sccmconnected-a01.cloudapp.net
- definitionupdates.microsoft.com
- configmgrbits.azureedge.net
- cmbitsstore.blob.core.windows.net
- ceuswatcab01.blob.core.windows.net
- ceuswatcab02.blob.core.windows.net
- eaus2watcab01.blob.core.windows.net
- eaus2watcab02.blob.core.windows.net
- weus2watcab01.blob.core.windows.net
- weus2watcab02.blob.core.windows.net
- umwatsonc.events.data.microsoft.com
- *-umwatsonc.events.data.microsoft.com

## サービス接続ツールの動作条件の確認

以下でご案内の動作条件を各環境が満たしているかご確認ください。特に、インターネット接続環境に Visual C++ 再頒布可能パッケージがインストールされているかご確認ください。

# 実際の作業

## 使用状況データの生成

1. 階層最上位サイトサーバー (中央管理サイトサーバーもしくはプライマリサイトサーバー) に管理者権限でアクセスします。
2. 使用状況データを格納するフォルダを生成しておきます。 (例: C:\CMUsageData) 
3. ConfigMgrコンソールを開きます。
4. [管理]-[概要]-[サイトの構成]-[サイト]-[サーバーとサイト システムの役割]-サイトサーバーを選択-[サービス接続ポイント]-[プロパティ]を開きます。  
   ![](./20240317_01/20240317_01_01.png)
5. [オフラインのオンデマンド接続]を選択して、「OK」をクリックします。  
   ![](./20240317_01/20240317_01_02.png)
6. 階層最上位サイトサーバーにて SMS_Executive サービスを再起動します。
7. コマンドプロンプトを管理者権限で開きます。
8. カレントフォルダ を [ConfigMgr インストールフォルダ]\cd.latest\SMSSETUP\TOOLS\SeviceConnectionTool\ に移動します。
9.  以下のコマンドを実行します。  
   ```command
   ServiceConnectionTool.exe -prepare -usagedatadest [使用状況格納フォルダ]\UsageData.cab
   ```
   ※ [使用状況格納フォルダ]は 2 で作成したフォルダを指定します。

   ![](./20240317_01/20240317_01_03.png)  

## インターネット接続環境への使用可能状況データとサービス接続ツールの複製
10. 作成されたUsageData.cab と、 [ConfigMgr インストールフォルダ]\cd.latest\SMSSETUP\TOOLS\ServiceConnectionTool フォルダをインターネット接続可能な別環境に複製します。


## サービス接続環境での パッケージ ダウンロード 
11. インターネット接続可能な別環境に接続します。
12. 更新パッケージのダウンロード先フォルダを生成しておきます。 (例: C:\CMUpdatePkg) 
13. コマンドプロンプト を管理者権限で開きます。
14. カレント フォルダ　を複製したサービス接続ツールのフォルダに移動します。
15. ダウンロードのためのコマンドを実行します。アップデート用のパッケージだけを指定するため、下記では -downloadsiteversion を指定しています。
   ```command
      ServiceConnectionTool.exe -connect -downloadsiteversion -usagedatasrc [使用状況格納フォルダ] -updatepackdest [12.で指定したダウンロード先フォルダ]
   ```
   ※ この際、インターネット接続可能な環境が Proxy 接続が必要な場合は以下を指定します。
   ```command
      ServiceConnectionTool.exe -connect -downloadsiteversion -usagedatasrc [使用状況格納フォルダ] -updatepackdest [12.で指定したダウンロード先フォルダ] -proxyserveruri [Proxy URI] -proxyusername [Proxy User ID]
   ```
   
16. ダウンロードが開始すると、以下のように　[Uploading and downloading data is in progress. Please wait...] と表示されます。  
   ![](./20240317_01/20240317_01_04.png)  

17. ダウンロードが完了すると、以下のように入力が戻ります。
    ![](./20240317_01/20240317_01_05.png)  

18. 以下のようにファイルがダウンロードされていることを確認します。なお、以下で 5.93GB のデータがダウンロードされています。  
    ![](./20240317_01/20240317_01_06.png)  


## ダウンロードしたパッケージの転送
19. ダウンロードしたパッケージをインターネット接続環境から最上位サイトサーバーに複製します。

## サービス接続ツールによるインポート
20. 階層最上位サイト サーバー に接続します。
21. コマンド プロンプトを管理者権限で開きます。
22. カレント フォルダをサービス接続ツールのフォルダに変更します。
23. 以下のコマンドを実行します。
    ```command
    ServiceConnectionTool.exe -import -updatepacksrc [複製したパッケージのフォルダ]
    ```
24. インポートが開始すると、以下のように [Imporing data is in progress. Please wait...] と表示されます。  
   ![](./20240317_01/20240317_01_07.png)  
25. インポートが完了すると、以下のように入力が戻ります。  
    ![](./20240317_01/20240317_01_08.png)  

26. [ConfigMgrコンソール] - [管理] - [概要] - [更新とサービス] にてターゲットの更新プログラムが以下のように表示されていることを確認します。  
    ![](./20240317_01/20240317_01_09.png)  