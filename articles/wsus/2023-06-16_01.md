---
title: WSUS から更新プログラムが配信されないときのチェックポイント
date: 2023-06-16
tags:
  - WSUS
---

# WSUS で更新プログラムが配信されないときのチェックポイント
みなさま、こんにちは。WSUS サポート チームです。

今回は、WSUS から更新プログラムが配信されない問題が発生したときのチェックポイントをご紹介します。  
WSUS から更新プログラムが配信される仕組みについては、[こちらの記事](https://jpmem.github.io/blog/wsus/2023-05-02_01/)でご紹介しておりますので、こちらも是非ご確認ください。

## 設定値のチェック
WSUS クライアントの接続先となる WSUS サーバーについては、以下のドメイン ポリシー / ローカル ポリシーやレジストリで指定します。  

- ポリシー  
[コンピューターの構成] - [管理用テンプレート] - [Windows コンポーネント] - [Windows Update] - [イントラネットの Microsoft 更新サービスの場所を指定する]  
または  
[コンピューターの構成] - [管理用テンプレート] - [Windows コンポーネント] - [Windows Update] - [Windows Server Update Service から提供される更新プログラムの管理] - [イントラネットの Microsoft 更新サービスの場所を指定する]  

これらのポリシーが構成されると、下記レジストリ値がセットされます。

- レジストリ  
HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate  
WUServer: <WSUS サーバーの URL>  
WUStatusServer: <WSUS サーバーの URL>  
HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate  
UseWUServer: 1  

そのため、まずはレジストリ エディター (regedit) より、このレジストリに正しい値がセットされているかを確認しましょう。  
もし、想定しない WSUS サーバーの URL がセットされている場合は、ドメイン ポリシーまたはローカル ポリシーの設定値を見直して、正しい値をセットしてください。

## クライアントと WSUS の疎通チェック
WSUS クライアントが WSUS サーバーから更新プログラムを受信するためには、WSUS サーバーに対して HTTP リクエストが送信できるネットワーク環境である必要があります。  
WSUS サーバーの接続先となる URL については、上述で説明したレジストリ値に格納されています。  
URL が IP アドレスではなく FQDN やホスト名になっている場合、名前解決ができるか確認する必要がありますので、まずはターミナルや PowerShell コンソールを開いて以下のコマンドを実行し IP アドレスを取得できるか確認しましょう。

例) URL が http://WSUS.contoso.com:8530 の場合
```
nslookup WSUS.contoso.com
```

出力例  
```
Server:  UnKnown
Address:  192.168.1.1

Name:    WSUS.contoso.com
Address:  192.168.1.10
```

ここで IP アドレスが取得できなかった場合、名前解決失敗エラーとなりますので、DNS の設定や FQDN が正しいか見直してください。  
名前解決ができることを確認した後は、以下の PowerShell コマンドを実行して、この URL に対して、HTTP リクエストが送信できるかどうかを確認しましょう。  

例) URL が http://WSUS.contoso.com:8530 の場合
```
Invoke-WebRequest -Uri http://WSUS.contoso.com:8530/ClientWebService/Client.asmx?wsdl -UseBasicParsing
Invoke-WebRequest -Uri http://WSUS.contoso.com:8530/SimpleAuthWebService/SimpleAuth.asmx -UseBasicParsing
```

アクセス可能な場合は、以下のように StatusCode 200 の出力結果となりますので、このような出力となるかご確認ください。  

出力例  
```
StatusCode        : 200
StatusDescription : OK
...<省略>
```

もし、StausCode が 407 の Proxy Authentication Required エラーなどが返された場合、プロキシを経由して WSUS サーバーにアクセスした結果、認証ができずに失敗していることが疑われます。  
そのときは、以下のコマンドで WinHTTP のプロキシ設定を確認してください。  

```
netsh winhttp show proxy
```

もし、設定されている場合、バイパスリストに WSUS サーバーの FQDN やそのドメインが含まれていなければ、プロキシを経由することになります。  
その場合は、プロキシ設定が不要であればリセットするか、バイパスリストに WSUS サーバーを追加することをご検討ください。  

- リセットするコマンド
```
netsh winhttp reset proxy
```

- バイパスリストを追加するコマンド  
- 例) URL が http://WSUS.contoso.com:8530 の場合
```
netsh set proxy proxy-server="<既存のプロキシ サーバー名>" bypass-list="<既存のバイパス リスト>;WSUS.contoso.com"
```
※ ドメイン名をバイパス リストに追加する場合は、*.contoso.com としてください。

プロキシを経由していないにもかかわらず、StausCode が 503 などのサーバー エラーが返された場合、WSUS サーバー側で問題が発生している可能性があるので、次の確認に進みます。

## WSUS サーバーの正常性チェック
WsusPool の停止などによって、WSUS サーバーが正常に動作していない場合、クライアントからの更新プログラムの確認がエラーとなります。  
WsusPool の停止が発生している場合、WSUS 管理コンソールが開けない状態となりますので、まず WSUS サーバーにログオンし、WSUS 管理コンソールを起動して、情報が確認できるかどうかご確認ください。  

WSUS コンソール起動時にエラーが発生して情報が確認できない場合は、[WSUS コンソールが全く開かなくなってしまった！ WsusPool の停止とは](https://jpmem.github.io/blog/wsus/2022-05-23_01/) の記事をもとに対処を実施しましょう。

## 上記のいずれも問題なかった場合
WSUS サーバーも問題なく動作しており、クライアントとサーバー間の接続も問題なかった場合は、WSUS サーバーのパフォーマンス劣化により、クライアントからのリクエストに対する応答に時間がかかることで、タイムアウト エラーが発生している可能性があります。  
この場合は、まず対象の WSUS サーバーで [WSUS メンテナンスガイド新版](https://jpmem.github.io/blog/wsus/2022-05-09_01/) を実施いただき、WSUS サーバーのメンテナンスを実施しましょう。これによって、パフォーマンスを改善し、応答までの時間短縮を試みます。  

これでもタイムアウトが発生する場合は、可能な限り WSUS サーバー側で不要な更新プログラムを「拒否済み」に設定する対処方法が効果的です。  
例えば、Windows Server 2016 など、リリースされてから時間が経過している OS の累積更新プログラムについては、過去の更新プログラムとの置換関係を保持し続けている関係上、カタログ情報（メタデータ）が肥大化しているため、「未承認」や「インストール承認」の更新プログラムが多いと、タイムアウト エラーなどが発生しやすくなります。  

OS の累積更新プログラムについては、最新の更新プログラムを配信していれば、それによって置き換えられた更新プログラムを配信しても、クライアント側に配信されませんので、特別な要件が無い限り「未承認」や「インストール承認」のままにしておく必要はありません。  
例えば、2023 年 6 月の Windows Server 2016 累積更新プログラムを「インストール承認」している場合、それによって置き換えられた更新プログラムは「拒否済み」にすることができます。  
「拒否済み」については、[不要な更新プログラムは「拒否済み」に設定しよう！](https://jpmem.github.io/blog/wsus/2017-12-11_01/)にて紹介していますので、実施をご検討ください。

